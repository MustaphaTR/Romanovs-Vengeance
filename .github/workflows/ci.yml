name: Build and Package OpenRA Mod

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y make zip tar

      - name: Extract release tag
        id: extract
        run: echo "TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Build all packages
        run: make VERSION=${{ env.TAG }}

      - name: Debug â€“ list output
        run: ls -lh dist/

      - name: Upload Windows package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/Mishmash-windows-${{ env.TAG }}.zip
          asset_name: Mishmash-windows.zip
          tag: ${{ github.ref_name }}

      - name: Upload Linux package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/Mishmash-linux-${{ env.TAG }}.tar.gz
          asset_name: Mishmash-linux.tar.gz
          tag: ${{ github.ref_name }}

      - name: Upload macOS package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/Mishmash-macos-${{ env.TAG }}.tar.gz
          asset_name: Mishmash-macos.tar.gz
          tag: ${{ github.ref_name }}
